<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Repo Explorer â€” VSCode-style</title>

<!-- External libs -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

<style>
  :root{
    --bg: #0f1720;
    --panel-bg: #0b1220;
    --muted: #9aa4b2;
    --accent: #42b983;
    --card: #0b1226;
    --glass: rgba(255,255,255,0.03);
    --text: #e6eef6;
  }
  /* Light theme variables */
  :root.light{
    --bg: #f6f8fa;
    --panel-bg: #ffffff;
    --muted: #6b7280;
    --accent: #0366d6;
    --card: #ffffff;
    --glass: rgba(0,0,0,0.03);
    --text: #111827;
  }

  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{background:linear-gradient(180deg,var(--bg),var(--panel-bg)); color:var(--text); display:flex; height:100vh; overflow:hidden;}

  /* Layout */
  .app { display:grid; grid-template-columns: 320px 1fr 420px; gap:18px; width:100%; padding:18px; box-sizing:border-box; }

  /* Sidebar */
  .sidebar { background:var(--card); border-radius:12px; padding:12px; display:flex; flex-direction:column; box-shadow: 0 8px 30px rgba(2,6,23,0.6); overflow:auto; }
  .sidebar .brand { display:flex; align-items:center; gap:10px; padding:8px 6px; margin-bottom:6px; }
  .logo { width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; background:linear-gradient(135deg,var(--accent),#00b894); color:white; }
  .repo-name { font-weight:700; color:var(--text); }
  .repo-meta { font-size:12px; color:var(--muted); margin-top:2px; }

  .sidebar-controls { display:flex; gap:8px; margin:10px 0; }
  .btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text); padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
  .btn.primary { background:linear-gradient(90deg,var(--accent),#00b894); color:white; border:none; box-shadow:0 6px 18px rgba(2,6,23,0.6); }
  .small { padding:6px 8px; font-size:13px }

  /* Tree */
  .tree { margin-top:6px; padding-bottom:18px; }
  .tree ul { list-style:none; margin:0; padding-left:6px; }
  .tree-item { padding:8px 10px; border-radius:8px; display:flex; align-items:center; gap:8px; cursor:pointer; transition:all .12s ease; color:var(--text); }
  .tree-item:hover { background:var(--glass); transform:translateY(-2px); }
  .tree-item .meta { font-size:13px; color:var(--muted); margin-left:auto; }
  .caret { width:18px; display:inline-flex; justify-content:center; align-items:center; transform:rotate(0deg); transition:transform .12s; }
  .caret.open { transform:rotate(90deg); }

  .folder { font-size:18px; color:var(--accent); }
  .file { font-size:16px; color:var(--muted); }

  /* Middle - main area */
  .main { background:transparent; display:flex; flex-direction:column; }
  .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
  .search-box { display:flex; gap:8px; align-items:center; width:100%; }
  .search { flex:1; display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; background:var(--card); border:1px solid rgba(255,255,255,0.04); }
  .search input { width:100%; background:transparent; border:none; outline:none; color:var(--text); font-size:15px; }
  .toggles { display:flex; gap:8px; align-items:center; }

  .panel { background:var(--card); border-radius:12px; padding:14px; box-shadow: 0 8px 30px rgba(2,6,23,0.6); flex:1; overflow:auto; }

  /* Search / results */
  .search-helpers { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; color:var(--muted); font-size:13px; }
  .results { display:flex; flex-direction:column; gap:8px; }
  .result { background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border-radius:8px; padding:10px; display:flex; gap:10px; align-items:center; cursor:pointer; transition:transform .08s; border:1px solid rgba(255,255,255,0.03); }
  .result:hover, .result.focused { transform:translateY(-4px); box-shadow:0 8px 20px rgba(2,6,23,0.6); }
  .result .r-left { width:36px; text-align:center; font-size:18px; color:var(--accent); }
  .result .r-body { flex:1; }
  .result .r-name { font-weight:600; color:var(--text); }
  .result .r-path { font-size:13px; color:var(--muted); margin-top:4px; }

  .highlight { background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); padding:2px 6px; border-radius:4px; color:var(--accent); }

  /* Right preview */
  .preview { background:var(--card); border-radius:12px; padding:16px; overflow:auto; height:100%; display:flex; flex-direction:column; }
  .preview .meta { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
  .preview .meta .title { font-weight:700; font-size:16px; color:var(--text); }
  .preview .content { flex:1; overflow:auto; font-size:14px; color:var(--text); }
  .preview pre { background:transparent; padding:12px; border-radius:8px; overflow:auto; border:1px solid rgba(255,255,255,0.03); color:var(--text); }

  /* Loading overlay */
  .overlay { position:fixed; left:0; right:0; top:0; bottom:0; display:flex; align-items:center; justify-content:center; z-index:9999; background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.6)); color:white; font-weight:700; font-size:16px; display:none; }
  .overlay.show { display:flex; }

  /* Controls row in preview */
  .controls { display:flex; gap:8px; margin-bottom:8px; align-items:center; }

  /* Sort / filters */
  .filters { display:flex; gap:8px; align-items:center; }

  /* Responsive */
  @media(max-width:1100px){ .app { grid-template-columns: 280px 1fr; grid-template-rows: 1fr 420px; height:100vh; } .preview { grid-column:1/-1; grid-row:2/3; } }
  @media(max-width:700px){ .app { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; padding:12px; gap:10px; } .sidebar { display:none; } }

  /* small helpers */
  .muted { color:var(--muted); font-size:13px; }
  .tiny { font-size:12px; color:var(--muted); }
  a.link { color:var(--accent); text-decoration:none; font-weight:600; }
</style>
</head>
<body class="">
<div class="overlay" id="overlay">Loading repositoryâ€¦</div>

<div class="app">

  <!-- Sidebar: File tree -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">R</div>
      <div>
        <div class="repo-name" id="repoTitle">owner/repo</div>
        <div class="repo-meta" id="repoMeta">Repository Explorer</div>
      </div>
    </div>

    <div class="sidebar-controls">
      <button class="btn small" id="refreshBtn">Refresh</button>
      <button class="btn small" id="collapseAll">Collapse</button>
      <button class="btn primary small" id="openAll">Expand</button>
      <button class="btn small" id="downloadZip">Download ZIP</button>
    </div>

    <div class="tree" id="fileTree">
      <div class="tiny muted">Loading treeâ€¦</div>
    </div>

    <div style="margin-top:auto;padding-top:12px">
      <div class="tiny muted">Tip: Use the search (center) to quickly find files.</div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <button class="btn" id="darkToggle">Toggle Dark</button>
        <a class="btn" id="openInGitHub" target="_blank" href="#">Open on GitHub</a>
      </div>
    </div>
  </aside>

  <!-- Middle: Search + results -->
  <main class="main">
    <div class="topbar">
      <div class="search-box">
        <div class="search">
          <svg style="width:18px;height:18px;opacity:.8" viewBox="0 0 24 24"><path fill="currentColor" d="M9.5 3A6.5 6.5 0 1 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0-2A8.5 8.5 0 1 0 18 9.5 8.5 8.5 0 0 0 9.5 1z"/><path fill="currentColor" d="M20.4 20.8 15.7 16.1a9 9 0 1 1 4.7 4.7z"/></svg>
          <input id="globalSearch" placeholder="Search files, folders, types... (try: README, .md, src) â€” âŒ˜/Ctrl+K" />
        </div>
        <div class="toggles">
          <div class="filters">
            <select id="sortSelect" class="btn small">
              <option value="score">Relevance</option>
              <option value="name">Name Aâ†’Z</option>
              <option value="type">Type</option>
              <option value="size">Size</option>
              <option value="modified">Last modified</option>
            </select>
          </div>
          <div>
            <button class="btn small" id="clearSearch">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <div class="panel" id="resultsPanel">
      <div class="search-helpers">
        <div id="resultCount">Type to search â€” results appear here.</div>
        <div class="muted tiny">Use â†‘ â†“ to navigate â€¢ Enter to open â€¢ Esc to clear</div>
      </div>

      <div class="results" id="resultsList">
      </div>
    </div>
  </main>

  <!-- Right: Preview -->
  <aside class="preview" id="previewPanel">
    <div class="controls">
      <div>
        <strong id="previewTitle">Select a file</strong>
        <div class="tiny muted" id="previewPath">Path will appear here</div>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <button class="btn small" id="openRaw" style="display:none">Open raw</button>
        <button class="btn small" id="fetchModified" title="Fetch last modified (lazy)">Fetch last modified</button>
      </div>
    </div>

    <div id="previewContent" class="content-area" style="flex:1; overflow:auto;">
      <div class="muted">Preview will appear here when you select a file.</div>
    </div>
  </aside>

</div>

<script>
/* ================== TOKEN PROMPT ================== */
let token = localStorage.getItem("gh_token");
if (!token) {
  token = prompt("Enter your GitHub Personal Access Token (PAT) to avoid rate limits:");
  if(token) localStorage.setItem("gh_token", token);
}
function authFetch(url, opts={}) {
  opts.headers = { ...(opts.headers||{}), ...(token ? {Authorization: `token ${token}`} : {}) };
  return fetch(url, opts);
}

/* ================== CONFIG â€” set repo owner & repo here ================== */
const owner = "sheik195";
const repo = "docsify";
/* ======================================================================== */

const apiBase = `https://api.github.com/repos/${owner}/${repo}`;
const contentsBase = `${apiBase}/contents`;
const commitsBase = `${apiBase}/commits`;

// State
let repoTree = [];
let flatFiles = [];
let fuse = null;
let results = [];
let focusedIndex = -1;
let overlay = document.getElementById('overlay');
let allFilesLoaded = false;
let lastModifiedCache = {};

document.getElementById('repoTitle').innerText = `${owner}/${repo}`;
document.getElementById('openInGitHub').href = `https://github.com/${owner}/${repo}`;

/* ================== UTILS ================== */
function showOverlay(text='Loadingâ€¦') { overlay.innerText = text; overlay.classList.add('show'); }
function hideOverlay() { overlay.classList.remove('show'); }
function humanBytes(bytes){
  if(bytes==null) return '-';
  const thresh = 1024;
  if (Math.abs(bytes) < thresh) return bytes + ' B';
  const units = ['KB','MB','GB','TB','PB','EB','ZB','YB'];
  let u = -1;
  do { bytes /= thresh; ++u; } while (Math.abs(bytes) >= thresh && u < units.length - 1);
  return bytes.toFixed(1)+' '+units[u];
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function highlightMatches(text, matches){
  if(!matches || matches.length===0) return escapeHtml(text);
  let indices = [];
  matches.forEach(m=>{ if(m.indices) indices.push(...m.indices); });
  if(indices.length===0) return escapeHtml(text);
  indices.sort((a,b)=>a[0]-b[0]);
  let merged = [];
  for(let i=0;i<indices.length;i++){
    const [s,e] = indices[i];
    if(!merged.length || s>merged[merged.length-1][1]+1) merged.push([s,e]);
    else merged[merged.length-1][1]=Math.max(merged[merged.length-1][1], e);
  }
  let out = ''; let last=0;
  for(const [s,e] of merged){
    out += escapeHtml(text.slice(last, s));
    out += '<span class="highlight">'+escapeHtml(text.slice(s, e+1))+'</span>';
    last = e+1;
  }
  out += escapeHtml(text.slice(last));
  return out;
}

/* ================== LOAD REPO ================== */
async function loadRepoRecursive(showOverlayText=true){
  showOverlayText && showOverlay('Scanning repository â€” fetching directory treeâ€¦');
  repoTree = [];
  flatFiles = [];
  lastModifiedCache = {};
  allFilesLoaded = false;

  const queue = [{path:'', node: {name: repo, path:'', type:'dir', children: []}}];
  repoTree.push(queue[0].node);

  while(queue.length){
    const item = queue.shift();
    const path = item.path;
    const parentNode = item.node;
    try {
      const url = path ? `${contentsBase}/${encodeURIComponent(path)}` : contentsBase;
      const res = await authFetch(url);
      if(!res.ok){
        const txt = await res.text();
        console.warn(res.status, txt);
        if(res.status===403) { alert('Rate limit or access denied. Retry with token.'); break; }
        break;
      }
      const items = await res.json();
      items.sort((a,b)=>{ if(a.type===b.type) return a.name.localeCompare(b.name); return (a.type==='dir'? -1:1); });
      for(const f of items){
        const node = {name:f.name, path:f.path, type:f.type};
        if(f.type==='dir') node.children=[];
        parentNode.children.push(node);
        if(f.type==='dir') queue.push({path:f.path, node});
        else flatFiles.push(node);
      }
    } catch(e){ console.error(e); }
  }

  fuse = new Fuse(flatFiles, {keys:['name','path'], threshold:0.3, ignoreLocation:true});
  renderTree();
  allFilesLoaded=true;
  hideOverlay();
}

/* ================== TREE RENDER ================== */
function renderTree(){
  const container = document.getElementById('fileTree');
  container.innerHTML='';
  function renderNode(node, ul){
    if(node.type==='dir'){
      const li = document.createElement('li');
      const div = document.createElement('div'); div.className='tree-item';
      const caret = document.createElement('span'); caret.className='caret'; caret.innerHTML='â–¶';
      const name = document.createElement('span'); name.textContent=node.name; name.className='folder';
      div.appendChild(caret); div.appendChild(name);
      li.appendChild(div);
      const childrenUl = document.createElement('ul'); childrenUl.style.display='none';
      li.appendChild(childrenUl);
      ul.appendChild(li);

      div.addEventListener('click', e=>{
        e.stopPropagation();
        if(caret.classList.contains('open')){
          caret.classList.remove('open');
          childrenUl.style.display='none';
        } else {
          caret.classList.add('open');
          childrenUl.style.display='block';
        }
      });
      node.children.forEach(c=>renderNode(c, childrenUl));
    } else {
      const li = document.createElement('li');
      const div = document.createElement('div'); div.className='tree-item file';
      div.textContent=node.name;
      div.addEventListener('click', ()=>previewFile(node));
      li.appendChild(div);
      ul.appendChild(li);
    }
  }
  const rootUl = document.createElement('ul');
  repoTree.forEach(n=>renderNode(n, rootUl));
  container.appendChild(rootUl);
}

/* ================== SEARCH ================== */
function performSearch(query){
  const resultsDiv = document.getElementById('resultsList');
  const resultCount = document.getElementById('resultCount');
  if(!query) { resultsDiv.innerHTML=''; resultCount.innerText='Type to search'; return; }
  results = fuse.search(query, {limit:50}).map(r=>r.item);
  resultCount.innerText = results.length + ' result(s)';
  resultsDiv.innerHTML='';
  results.forEach((f, i)=>{
    const div = document.createElement('div'); div.className='result';
    div.innerHTML=`<div class="r-left">ðŸ“„</div>
      <div class="r-body">
        <div class="r-name">${highlightMatches(f.name, fuse.search(query).map(s=>s.matches))}</div>
        <div class="r-path">${highlightMatches(f.path, fuse.search(query).map(s=>s.matches))}</div>
      </div>`;
    div.addEventListener('click', ()=>previewFile(f));
    resultsDiv.appendChild(div);
  });
}

/* ================== PREVIEW ================== */
async function previewFile(f){
  document.getElementById('previewTitle').innerText = f.name;
  document.getElementById('previewPath').innerText = f.path;
  document.getElementById('openRaw').style.display='inline-block';
  document.getElementById('openRaw').onclick = ()=>window.open(`https://raw.githubusercontent.com/${owner}/${repo}/main/${f.path}`);
  const previewContent = document.getElementById('previewContent');
  previewContent.innerHTML='<div class="muted">Loading contentâ€¦</div>';
  try{
    const res = await authFetch(`${contentsBase}/${encodeURIComponent(f.path)}`);
    if(!res.ok) { previewContent.innerHTML='Error fetching file.'; return; }
    const data = await res.json();
    const content = atob(data.content.replace(/\n/g,''));
    if(f.name.endsWith('.md')) {
      previewContent.innerHTML = marked.parse(content);
    } else {
      previewContent.innerHTML = `<pre><code>${escapeHtml(content)}</code></pre>`;
      hljs.highlightAll();
    }
  } catch(e){ previewContent.innerHTML='Error fetching file.'; console.error(e); }
}

/* ================== DOWNLOAD ZIP ================== */
document.getElementById('downloadZip').addEventListener('click', ()=>{
  window.open(`https://github.com/${owner}/${repo}/archive/refs/heads/main.zip`);
});

/* ================== EVENT LISTENERS ================== */
document.getElementById('refreshBtn').addEventListener('click', ()=>loadRepoRecursive());
document.getElementById('clearSearch').addEventListener('click', ()=>{
  document.getElementById('globalSearch').value='';
  performSearch('');
});
document.getElementById('globalSearch').addEventListener('input', e=>{
  performSearch(e.target.value);
});
document.getElementById('darkToggle').addEventListener('click', ()=>{
  document.body.classList.toggle('light');
});
document.getElementById('collapseAll').addEventListener('click', ()=>{
  document.querySelectorAll('.caret.open').forEach(c=>c.click());
});
document.getElementById('openAll').addEventListener('click', ()=>{
  document.querySelectorAll('.tree-item .caret:not(.open)').forEach(c=>c.click());
});

/* ================== INIT ================== */
loadRepoRecursive();
</script>
</body>
</html>
